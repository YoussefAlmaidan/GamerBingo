<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TASK BATTLE - Real-Time Competition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c0c1d 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            position: sticky;
            top: 0;
            background: rgba(13, 13, 29, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255, 107, 107, 0.5);
        }

        .game-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.9rem;
        }

        .status-item {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            min-height: calc(100vh - 100px);
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            height: fit-content;
            position: sticky;
            top: 120px;
        }

        .section {
            margin-bottom: 2rem;
        }

        .section h3 {
            margin-bottom: 1rem;
            color: #4ecdc4;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .join-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .input-group {
            position: relative;
        }

        input, select {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: #ffffff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #4ecdc4;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.3);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
        }

        .players-list {
            list-style: none;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 4px solid;
        }

        .leaderboard {
            list-style: none;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .leaderboard-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--progress, 0%);
            background: linear-gradient(90deg, rgba(78, 205, 196, 0.2), rgba(255, 107, 107, 0.2));
            transition: width 0.5s ease;
        }

        .leaderboard-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            padding: 1rem;
        }

        .task-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1.5rem;
            min-height: 160px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .task-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(78, 205, 196, 0.5);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        .task-card.completed {
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 30px rgba(78, 205, 196, 0.2);
        }

        .task-card.completed::before {
            content: '✓';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 10px currentColor;
            z-index: 2;
        }

        .task-card.editing {
            border-color: #ffeb3b;
            box-shadow: 0 0 20px rgba(255, 235, 59, 0.3);
        }

        .task-edit-input {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            color: white;
            text-align: center;
            font-size: 0.95rem;
            resize: none;
            outline: none;
        }

        .floating-admin {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .floating-admin:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .admin-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(13, 13, 29, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 2rem;
            z-index: 10000;
            min-width: 300px;
        }

        .admin-panel h3 {
            color: #ff6b6b;
            margin-bottom: 1rem;
            text-align: center;
        }

        .admin-actions {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .admin-btn {
            padding: 0.75rem;
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 10px;
            color: #ff6b6b;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .admin-btn:hover {
            background: rgba(255, 107, 107, 0.3);
            transform: translateY(-2px);
        }

        .winner-announcement {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            backdrop-filter: blur(10px);
        }

        .winner-content {
            text-align: center;
            padding: 3rem;
            background: rgba(13, 13, 29, 0.95);
            border-radius: 20px;
            border: 2px solid #4ecdc4;
            box-shadow: 0 0 50px rgba(78, 205, 196, 0.5);
        }

        .winner-content h2 {
            font-size: 3rem;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .sidebar {
                position: static;
                order: -1;
            }
            
            .game-board {
                grid-template-columns: repeat(5, 1fr);
                gap: 0.5rem;
            }
            
            .task-card {
                min-height: 120px;
                padding: 1rem;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .logo {
                font-size: 1.5rem;
            }
            
            .game-status {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .game-board {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .task-card {
                min-height: 100px;
                padding: 0.75rem;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .game-board {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .task-card {
                min-height: 80px;
                padding: 0.5rem;
                font-size: 0.75rem;
            }
            
            .container {
                padding: 0.5rem;
            }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">TASK BATTLE</div>
            <div class="game-status">
                <div class="status-item">
                    Players: <span id="playerCount">0</span>
                </div>
                <div class="status-item">
                    Completed: <span id="completedCount">0</span>/25
                </div>
                <div class="status-item">
                    Status: <span id="gameStatus">Waiting for players</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="sidebar">
            <div class="section">
                <h3>Join Game</h3>
                <div class="join-form">
                    <input type="text" id="playerName" placeholder="Enter your name" maxlength="20">
                    <button class="btn" onclick="joinGame()">Join Battle</button>
                </div>
            </div>

            <div class="section">
                <h3>Select Player</h3>
                <select id="playerSelect">
                    <option value="">Choose your player</option>
                </select>
            </div>

            <div class="section">
                <h3>Players</h3>
                <ul id="playersList" class="players-list"></ul>
            </div>

            <div class="section">
                <h3>Leaderboard</h3>
                <ul id="leaderboard" class="leaderboard"></ul>
            </div>
        </div>

        <div class="game-board" id="gameBoard"></div>
    </div>

    <div class="floating-admin" id="adminToggle" onclick="handleAdminClick()">
        ⚙️
    </div>

    <div class="admin-panel hidden" id="adminPanel">
        <h3>Admin Panel</h3>
        <div class="admin-actions">
            <button class="admin-btn" onclick="resetGame()">Reset Entire Game</button>
            <button class="admin-btn" onclick="clearTasks()">Clear All Tasks</button>
            <button class="admin-btn" onclick="removeLastPlayer()">Remove Last Player</button>
            <button class="admin-btn" onclick="toggleEditMode()">Toggle Edit Mode</button>
            <button class="admin-btn" onclick="closeAdminPanel()">Close Panel</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBMS5W47Xjn5G0mO2Me5xIKalLzv-ukLZA",
            authDomain: "gamerbingo-fc745.firebaseapp.com",
            databaseURL: "https://gamerbingo-fc745-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gamerbingo-fc745",
            storageBucket: "gamerbingo-fc745.firebasestorage.app",
            messagingSenderId: "864050565555",
            appId: "1:864050565555:web:133ceb64c6f116b5cabbc6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Game state
        let currentPlayer = null;
        let isEditMode = false;
        let adminClickCount = 0;
        let adminClickTimer = null;

        // Default tasks
        const defaultTasks = [
            "Share your favorite movie quote",
            "Name 3 things you're grateful for",
            "Do 10 jumping jacks",
            "Show your best dance move",
            "Tell a dad joke",
            "Draw something in 30 seconds",
            "Sing your favorite song line",
            "Name 5 countries starting with 'S'",
            "Do your best animal impression",
            "Share an embarrassing childhood story",
            "Name all planets in our solar system",
            "Do a 30-second plank",
            "Recite the alphabet backwards",
            "Share your dream vacation destination",
            "Name 7 colors in the rainbow",
            "Do 5 push-ups",
            "Tell us about your first pet",
            "Name 3 capital cities",
            "Show your best magic trick",
            "Share your biggest fear",
            "Name 5 types of pasta",
            "Do your best celebrity impression",
            "Share your favorite childhood memory",
            "Name 4 elements from periodic table",
            "Tell us your superpower wish"
        ];

        // Player colors
        const playerColors = [
            '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57',
            '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#ff9f43',
            '#10ac84', '#ee5a6f', '#0abde3', '#3867d6', '#8854d0'
        ];

        // Initialize game
        function initializeGame() {
            setupTaskBoard();
            setupRealtimeListeners();
            loadPlayerSelect();
        }

        // Setup task board
        function setupTaskBoard() {
            const gameBoard = document.getElementById('gameBoard');
            gameBoard.innerHTML = '';

            for (let i = 0; i < 25; i++) {
                const taskCard = document.createElement('div');
                taskCard.className = 'task-card';
                taskCard.dataset.taskId = i;
                taskCard.textContent = defaultTasks[i];
                taskCard.onclick = () => handleTaskClick(i);
                taskCard.ondblclick = () => handleTaskDoubleClick(i);
                taskCard.oncontextmenu = (e) => handleTaskRightClick(e, i);
                gameBoard.appendChild(taskCard);
            }
        }

        // Setup realtime listeners
        function setupRealtimeListeners() {
            // Listen to players
            onValue(ref(database, 'players'), (snapshot) => {
                const players = snapshot.val() || {};
                updatePlayersList(players);
                updatePlayerSelect(players);
                updateLeaderboard(players);
                updateGameStatus(players);
            });

            // Listen to tasks
            onValue(ref(database, 'tasks'), (snapshot) => {
                const tasks = snapshot.val() || {};
                updateTaskBoard(tasks);
                checkGameEnd();
            });
        }

        // Join game
        window.joinGame = function() {
            const nameInput = document.getElementById('playerName');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Please enter your name!');
                return;
            }

            const playerId = Date.now() + Math.random();
            const colorIndex = Object.keys(getPlayersSync()).length % playerColors.length;
            
            const playerData = {
                name: name,
                color: playerColors[colorIndex],
                score: 0,
                joinedAt: Date.now()
            };

            set(ref(database, `players/${playerId}`), playerData).then(() => {
                nameInput.value = '';
                alert('Joined the game! Select yourself from the dropdown to start playing.');
            });
        };

        // Handle task click
        function handleTaskClick(taskId) {
            if (!currentPlayer) {
                alert('Please select your player first!');
                return;
            }

            if (isEditMode) return;

            const tasks = getTasksSync();
            if (tasks[taskId]) return; // Already completed

            const players = getPlayersSync();
            const player = players[currentPlayer];
            if (!player) return;

            // Complete the task
            const taskData = {
                completedBy: currentPlayer,
                playerName: player.name,
                playerColor: player.color,
                completedAt: Date.now(),
                taskText: defaultTasks[taskId]
            };

            // Update task and player score
            const updates = {};
            updates[`tasks/${taskId}`] = taskData;
            updates[`players/${currentPlayer}/score`] = (player.score || 0) + 1;

            update(ref(database), updates);
        }

        // Handle task double click (edit mode)
        function handleTaskDoubleClick(taskId) {
            if (!isEditMode) return;
            
            const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
            const currentText = taskCard.textContent;
            
            taskCard.classList.add('editing');
            taskCard.innerHTML = `<textarea class="task-edit-input">${currentText}</textarea>`;
            
            const textarea = taskCard.querySelector('.task-edit-input');
            textarea.focus();
            textarea.select();
            
            const saveEdit = () => {
                const newText = textarea.value.trim();
                if (newText) {
                    taskCard.textContent = newText;
                    // Update in database if you want to sync custom tasks
                }
                taskCard.classList.remove('editing');
            };
            
            textarea.onblur = saveEdit;
            textarea.onkeydown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    saveEdit();
                }
            };
        }

        // Handle task right click (cancel completion)
        function handleTaskRightClick(e, taskId) {
            e.preventDefault();
            if (!isEditMode) return;
            
            const tasks = getTasksSync();
            if (!tasks[taskId]) return;
            
            if (confirm('Cancel this task completion?')) {
                const playerWhoCompleted = tasks[taskId].completedBy;
                const players = getPlayersSync();
                
                const updates = {};
                updates[`tasks/${taskId}`] = null;
                if (players[playerWhoCompleted]) {
                    updates[`players/${playerWhoCompleted}/score`] = Math.max(0, (players[playerWhoCompleted].score || 1) - 1);
                }
                
                update(ref(database), updates);
            }
        }

        // Update task board
        function updateTaskBoard(tasks) {
            const taskCards = document.querySelectorAll('.task-card');
            let completedCount = 0;
            
            taskCards.forEach((card, index) => {
                card.classList.remove('completed');
                card.style.background = '';
                card.style.borderColor = '';
                
                if (tasks[index]) {
                    card.classList.add('completed');
                    card.style.background = `linear-gradient(135deg, ${tasks[index].playerColor}40, ${tasks[index].playerColor}20)`;
                    card.style.borderColor = tasks[index].playerColor;
                    completedCount++;
                }
            });
            
            document.getElementById('completedCount').textContent = completedCount;
        }

        // Update players list
        function updatePlayersList(players) {
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';
            
            Object.entries(players).forEach(([id, player]) => {
                const li = document.createElement('li');
                li.className = 'player-item';
                li.style.borderLeftColor = player.color;
                li.innerHTML = `
                    <span>${player.name}</span>
                    <span>${player.score || 0}</span>
                `;
                playersList.appendChild(li);
            });
            
            document.getElementById('playerCount').textContent = Object.keys(players).length;
        }

        // Update player select dropdown
        function updatePlayerSelect(players) {
            const playerSelect = document.getElementById('playerSelect');
            const currentValue = playerSelect.value;
            
            playerSelect.innerHTML = '<option value="">Choose your player</option>';
            
            Object.entries(players).forEach(([id, player]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = player.name;
                option.style.color = player.color;
                playerSelect.appendChild(option);
            });
            
            if (currentValue && players[currentValue]) {
                playerSelect.value = currentValue;
            }
        }

        // Load player select
        function loadPlayerSelect() {
            const playerSelect = document.getElementById('playerSelect');
            playerSelect.onchange = function() {
                currentPlayer = this.value;
                if (currentPlayer) {
                    const players = getPlayersSync();
                    const player = players[currentPlayer];
                    if (player) {
                        document.title = `TASK BATTLE - ${player.name}`;
                    }
                }
            };
        }

        // Update leaderboard
        function updateLeaderboard(players) {
            const leaderboard = document.getElementById('leaderboard');
            leaderboard.innerHTML = '';
            
            const sortedPlayers = Object.entries(players)
                .sort(([,a], [,b]) => (b.score || 0) - (a.score || 0));
            
            const maxScore = Math.max(...Object.values(players).map(p => p.score || 0), 1);
            
            sortedPlayers.forEach(([id, player], index) => {
                const li = document.createElement('li');
                li.className = 'leaderboard-item';
                li.style.setProperty('--progress', `${((player.score || 0) / maxScore) * 100}%`);
                
                const rank = index + 1;
                const medal = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : `${rank}.`;
                
                li.innerHTML = `
                    <div class="leaderboard-content">
                        <span>${medal} ${player.name}</span>
                        <span style="color: ${player.color}; font-weight: bold;">${player.score || 0}</span>
                    </div>
                `;
                leaderboard.appendChild(li);
            });
        }

        // Update game status
        function updateGameStatus(players) {
            const playerCount = Object.keys(players).length;
            const statusElement = document.getElementById('gameStatus');
            
            if (playerCount === 0) {
                statusElement.textContent = 'Waiting for players';
            } else if (playerCount === 1) {
                statusElement.textContent = 'Waiting for more players';
            } else {
                statusElement.textContent = 'Battle in progress!';
            }
        }

        // Check game end
        function checkGameEnd() {
            const tasks = getTasksSync();
            const completedTasks = Object.keys(tasks).length;
            
            if (completedTasks === 25) {
                const players = getPlayersSync();
                const winner = Object.entries(players).reduce((prev, current) => 
                    (current[1].score || 0) > (prev[1].score || 0) ? current : prev
                );
                
                showWinnerAnnouncement(winner[1]);
            }
        }

        // Show winner announcement
        function showWinnerAnnouncement(winner) {
            const announcement = document.createElement('div');
            announcement.className = 'winner-announcement';
            announcement.innerHTML = `
                <div class="winner-content">
                    <h2>🎉 VICTORY! 🎉</h2>
                    <h3 style="color: ${winner.color}; font-size: 2rem; margin-bottom: 1rem;">
                        ${winner.name}
                    </h3>
                    <p style="font-size: 1.2rem; margin-bottom: 2rem;">
                        Score: ${winner.score} tasks completed!
                    </p>
                    <button class="btn" onclick="this.parentElement.parentElement.remove()">
                        Continue Playing
                    </button>
                </div>
            `;
            document.body.appendChild(announcement);
            
            setTimeout(() => {
                if (announcement.parentElement) {
                    announcement.remove();
                }
            }, 10000);
        }

        // Admin functions
        window.handleAdminClick = function() {
            adminClickCount++;
            
            if (adminClickTimer) {
                clearTimeout(adminClickTimer);
            }
            
            adminClickTimer = setTimeout(() => {
                adminClickCount = 0;
            }, 1000);
            
            if (adminClickCount === 3) {
                document.getElementById('adminPanel').classList.remove('hidden');
                adminClickCount = 0;
            }
        };

        window.closeAdminPanel = function() {
            document.getElementById('adminPanel').classList.add('hidden');
        };

        window.resetGame = function() {
            if (confirm('Reset entire game? This will remove all players and tasks!')) {
                const updates = {
                    players: null,
                    tasks: null
                };
                update(ref(database), updates);
                currentPlayer = null;
                document.getElementById('playerSelect').value = '';
                closeAdminPanel();
            }
        };

        window.clearTasks = function() {
            if (confirm('Clear all completed tasks?')) {
                // Reset all player scores to 0
                const players = getPlayersSync();
                const updates = { tasks: null };
                
                Object.keys(players).forEach(playerId => {
                    updates[`players/${playerId}/score`] = 0;
                });
                
                update(ref(database), updates);
                closeAdminPanel();
            }
        };

        window.removeLastPlayer = function() {
            const players = getPlayersSync();
            const playerEntries = Object.entries(players);
            
            if (playerEntries.length === 0) {
                alert('No players to remove!');
                return;
            }
            
            // Sort by joinedAt to find the last player
            const lastPlayer = playerEntries.sort(([,a], [,b]) => b.joinedAt - a.joinedAt)[0];
            const [lastPlayerId, lastPlayerData] = lastPlayer;
            
            if (confirm(`Remove ${lastPlayerData.name} and their completed tasks?`)) {
                // Remove tasks completed by this player
                const tasks = getTasksSync();
                const updates = {};
                
                Object.entries(tasks).forEach(([taskId, task]) => {
                    if (task.completedBy === lastPlayerId) {
                        updates[`tasks/${taskId}`] = null;
                    }
                });
                
                // Remove the player
                updates[`players/${lastPlayerId}`] = null;
                
                update(ref(database), updates);
                
                // If this was the current player, reset selection
                if (currentPlayer === lastPlayerId) {
                    currentPlayer = null;
                    document.getElementById('playerSelect').value = '';
                }
                
                closeAdminPanel();
            }
        };

        window.toggleEditMode = function() {
            isEditMode = !isEditMode;
            const gameBoard = document.getElementById('gameBoard');
            
            if (isEditMode) {
                gameBoard.style.border = '2px dashed #ffeb3b';
                alert('Edit mode ON: Double-click tasks to edit, right-click completed tasks to cancel them.');
            } else {
                gameBoard.style.border = 'none';
                alert('Edit mode OFF');
            }
            closeAdminPanel();
        };

        // Utility functions to get current data synchronously
        function getPlayersSync() {
            // This is a simplified approach - in a real app you'd maintain state
            return window.gameState?.players || {};
        }

        function getTasksSync() {
            return window.gameState?.tasks || {};
        }

        // Maintain game state for sync functions
        window.gameState = { players: {}, tasks: {} };
        
        onValue(ref(database, 'players'), (snapshot) => {
            window.gameState.players = snapshot.val() || {};
        });
        
        onValue(ref(database, 'tasks'), (snapshot) => {
            window.gameState.tasks = snapshot.val() || {};
        });

        // Initialize the game
        initializeGame();
    </script>
</body>
</html>
